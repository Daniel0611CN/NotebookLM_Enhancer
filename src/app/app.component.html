@let folderList = (folders$ | async) ?? [];
@let keyMap = (notebookFolderByKey$ | async) ?? {};
@let titleMap = (notebookFolderByTitle$ | async) ?? {};

<div class="flex h-full flex-col p-4 text-gray-700 dark:text-[#E3E3E3]" cdkDropListGroup>

  <!-- Minimalist Widget Container -->
  <div class="flex flex-col  rounded-2xl bg-white dark:bg-[#1E1F20] shadow-lg border border-gray-200 dark:border-[#3C4043] overflow-hidden">

    <!-- Header (Image 2 Style) -->
    <div class="flex items-center justify-between px-4 py-3">
      <div class="flex items-baseline gap-3">
        <h1 class="text-base font-normal text-gray-900 dark:text-[#E8EAED]">Folders</h1>
      </div>

      <div class="flex items-center gap-1">
        <!-- Theme Toggle -->
        <button
          class="flex h-8 w-8 items-center justify-center rounded-full text-gray-500 dark:text-[#9AA0A6] hover:bg-gray-100 dark:hover:bg-[#3C4043] hover:text-gray-700 dark:hover:text-[#E3E3E3] transition-colors"
          (click)="toggleTheme()" [title]="themeTooltip">
          @if (themeIcon === 'sun') {
            <!-- Sun icon for light mode -->
            <svg viewBox="0 0 24 24" class="h-5 w-5 fill-current" stroke="currentColor" stroke-width="2" fill="none">
              <circle cx="12" cy="12" r="5" fill="currentColor"/>
              <g stroke-linecap="round">
              <line x1="12" y1="1" x2="12" y2="3"/>
              <line x1="12" y1="21" x2="12" y2="23"/>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
              <line x1="1" y1="12" x2="3" y2="12"/>
              <line x1="21" y1="12" x2="23" y2="12"/>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
              </g>
            </svg>
          } @else if (themeIcon === 'moon') {
            <!-- Moon icon for dark mode -->
            
        
            <svg viewBox="0 0 24 24" class="h-4 w-4 fill-current">
                <path d="
                  M21 12
                  A9 9 0 1 1 12 3
                  A7 7 0 1 0 21 12
                "/>
              </svg>


          } @else {
            <!-- Monitor icon for system mode -->
            <svg viewBox="0 0 24 24" class="h-5 w-5 fill-current">
              <path d="M20 3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM20 16H4V5h16v11z"/>
              <path d="M12 18h2v2h-2z"/>
            </svg>
          }
        </button>

        <!-- New Folder -->
        <button
          class="flex h-8 w-8 items-center justify-center rounded-full text-gray-500 dark:text-[#9AA0A6] hover:bg-gray-100 dark:hover:bg-[#3C4043] hover:text-gray-700 dark:hover:text-[#E3E3E3] transition-colors"
          (click)="createFolder()" title="Nueva carpeta">
          <svg viewBox="0 0 24 24" class="h-5 w-5 fill-current">
            <path
              d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2zM4 18V6h4.17l2 2H20v10H4z" />
            <g>
              <rect x="8" y="10" width="8" height="8" fill="none"/>
              <path d="M12 11v4M10 13h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </g>
          </svg>
        </button>

        <!-- Collapse -->
        <button
          class="flex h-8 w-8 items-center justify-center rounded-full text-gray-500 dark:text-[#9AA0A6] hover:bg-gray-100 dark:hover:bg-[#3C4043] hover:text-gray-700 dark:hover:text-[#E3E3E3] transition-colors transition-transform duration-200"
          [class.rotate-180]="isCollapsed" (click)="isCollapsed = !isCollapsed">
          <svg viewBox="0 0 24 24" class="h-5 w-5 fill-current">
            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" transform="rotate(90, 12, 12)" />
          </svg>
        </button>
      </div>
    </div>

    @if (!isCollapsed) {
    <!-- Divider -->
    <div class="mx-4 border-t border-gray-200 dark:border-[#3C4043]"></div>

    <!-- Main Content Area -->
      <div class="flex-1 overflow-y-auto p-2 scrollbar-thin">
        <!-- Inbox (Unassigned) -->
        <div class="px-1 pt-2">
        <div class="flex items-center justify-between gap-2 rounded-lg px-2 py-2 hover:bg-gray-50 dark:hover:bg-white/5">
          <div class="flex items-center gap-2 text-sm text-gray-700 dark:text-[#E3E3E3]">
            <div class="text-blue-600 dark:text-[#8AB4F8]">
              <svg viewBox="0 0 24 24" class="h-5 w-5 fill-current">
                <path
                  d="M19 3H4.99C3.89 3 3 3.9 3 5v14c0 1.1.89 2 1.99 2H19c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 4l-7 5-7-5V5l7 5 7-5v2z" />
              </svg>
            </div>
            <div class="font-normal">Inbox</div>
          </div>

          <div class="text-xs text-gray-500 dark:text-[#9AA0A6]">{{ unsortedNotebooks.length }}</div>
        </div>

        <div
          class="ml-2 rounded-lg border border-gray-200 dark:border-[#3C4043] bg-gray-50/50 dark:bg-[#202124]/40"
          cdkDropList
          [cdkDropListData]="dropDataUnsorted"
          [cdkDropListSortingDisabled]="true"
          (cdkDropListDropped)="onNotebookDropped($event)"
          data-nle-drop-folder-id=""
        >
          @if (unsortedNotebooks.length === 0) {
            <div class="px-3 py-2 text-xs text-gray-400 dark:text-[#5F6368]">Nada en Inbox</div>
          } @else {
            <div class="py-1">
              @for (nb of unsortedNotebooks; track nb.key) {
                <app-notebook-item
                  [notebook]="nb"
                  (open)="openNotebook($event)"
                  (openMenu)="openNotebookMenu($event)"
                />
              }
            </div>
          }
        </div>
      </div>

      <!-- Folder Tree -->
      <div class="px-1 py-2">
        <app-folder-tree [tree]="folderTree" [folders]="folderList" [notebooksByFolderId]="notebooksByFolderId"
          [notebookFolderByKey]="keyMap" [notebookFolderByTitle]="titleMap" (toggleFolder)="toggleFolder($event)"
          (createSubfolder)="createSubfolder($event)" (renameFolder)="renameFolder($event)"
          (deleteFolder)="deleteFolder($event)" (openNotebook)="openNotebook($event)"
          (openNotebookMenu)="openNotebookMenu($event)"
          (droppedNotebook)="onNotebookDropped($event)" />
      </div>
    </div>
    }
  </div>

</div>
